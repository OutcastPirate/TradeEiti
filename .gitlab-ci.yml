stages:
  - build
  - deploy

variables:
  FRONTEND_IMAGE_NAME: front
  BACKEND_IMAGE_NAME: back
  SSH_HOST: arcziweb.com
  SSH_PORT: 22
  SSH_USER: pap

services:
  - docker:19-dind


before_script:
  - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin

  - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - chmod 400 "$SSH_PRIVATE_KEY"
  - ssh-add "$SSH_PRIVATE_KEY"
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh

  - export DOCKER_HOST=tcp://docker:2375

build_frontend:
  stage: build
  script:
    - cd frontend
    - docker build -t $DOCKER_HUB_USERNAME/$FRONTEND_IMAGE_NAME:$CI_COMMIT_REF_NAME .
    - docker push $DOCKER_HUB_USERNAME/FRONTEND_IMAGE_NAME:$CI_COMMIT_REF_NAME

build_backend:
  stage: build
  script:
    - cd backend
    - docker build -t $DOCKER_HUB_USERNAME/$BACKEND_IMAGE_NAME:$CI_COMMIT_REF_NAME .
    - docker push $DOCKER_HUB_USERNAME/BACKEND_IMAGE_NAME:$CI_COMMIT_REF_NAME

deploy_all:
  stage: deploy
  script:
    - ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "docker pull $DOCKER_HUB_USERNAME/$FRONTEND_IMAGE_NAME:$CI_COMMIT_REF_NAME"
    - ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "docker pull $DOCKER_HUB_USERNAME/BACKEND_IMAGE_NAME:$CI_COMMIT_REF_NAME"
    - ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "sed -i 's|$DOCKER_HUB_USERNAME/$FRONTEND_IMAGE_NAME:.*|$DOCKER_HUB_USERNAME/$FRONTEND_IMAGE_NAME:$CI_COMMIT_REF_NAME|' usos/docker-compose.yml"
    - ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "sed -i 's|$DOCKER_HUB_USERNAME/BACKEND_IMAGE_NAME:.*|$DOCKER_HUB_USERNAME/BACKEND_IMAGE_NAME:$CI_COMMIT_REF_NAME|' usos/docker-compose.yml"
    - cd usos && docker compose stop && docker-compose build && docker-compose up -d

